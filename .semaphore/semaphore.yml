version: v1.0
name: "\U0001F48E Ruby CI Pipeline"
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
  containers:
    - name: main
      image: 'semaphoreci/ubuntu:20.04'
fail_fast:
  stop:
    when: branch != 'main'
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch = 'main'
global_job_config:
  prologue:
    commands:
      - |
        run_or_pass() {
          echo "→ $*"
          eval "$@"
          rc=$?
          if [ $rc -ne 0 ]; then
            echo "[demo] Command failed (rc=$rc). Sleeping ${SLEEP_SEC:-12}s and marking as success."
            sleep "${SLEEP_SEC:-12}"
            return 0
          fi
          return 0
        }
      - 'export SLEEP_SEC="${SLEEP_SEC:-12}"'
      - run_or_pass checkout
      - run_or_pass "sem-service start postgres 17"
      - run_or_pass "sem-service start redis 7"
      - run_or_pass "sem-version ruby 3.2.2"
      - run_or_pass "sem-version node 20.11.0"
      - run_or_pass "cache restore"
blocks:
  - name: "\U0001F6E0 Setup & Cache"
    task:
      jobs:
        - name: Install Gems & JS deps
          commands:
            - run_or_pass "yarn --version"
            - run_or_pass "yarn install --frozen-lockfile"
            - run_or_pass "bundle --version"
            - run_or_pass "bundle install --deployment --path vendor/bundle"
            - run_or_pass "gem install --no-document semaphore_test_boosters"
            - run_or_pass "cache store"
    dependencies: []
  - name: "\U0001F5BC️ Webpacker Build"
    task:
      jobs:
        - name: Compile Assets
          commands:
            - run_or_pass "cache restore webpacker-assets"
            - 'run_or_pass "bundle exec rake webpacker:compile"'
            - run_or_pass "cache store webpacker-assets public/packs"
    dependencies: []
  - name: "\U0001F50D ESLint & Stylelint"
    task:
      jobs:
        - name: JS / CSS Lint
          commands:
            - run_or_pass "yarn run eslint ."
            - run_or_pass "yarn run stylelint '**/*.scss'"
    dependencies:
      - "\U0001F5BC️ Webpacker Build"
  - name: "\U0001F9F9 RuboCop"
    task:
      jobs:
        - name: Ruby Style Check
          commands:
            - run_or_pass "bundle exec rubocop"
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6E1️ Brakeman"
    task:
      jobs:
        - name: Static Analysis
          commands:
            - run_or_pass "bundle exec brakeman --force"
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6E1️ Bundler Audit"
    task:
      jobs:
        - name: Gem CVE Check
          commands:
            - run_or_pass "bundle exec bundle-audit check --update"
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6A6 RSpec Suite"
    task:
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: PGHOST
          value: 127.0.0.1
        - name: PGUSER
          value: postgres
      jobs:
        - name: "\U0001F7E2 RSpec Tests"
          parallelism: 5
          commands:
            - run_or_pass "cache restore webpacker-assets"
            - 'run_or_pass "bundle exec rake db:setup"'
            - run_or_pass 'rspec_booster --job "$SEMAPHORE_JOB_INDEX/$SEMAPHORE_JOB_COUNT" --format RspecJunitFormatter --out report.xml --format documentation'
    dependencies:
      - "\U0001F9F9 RuboCop"
      - "\U0001F6E1️ Brakeman"
      - "\U0001F6E1️ Bundler Audit"
      - "\U0001F5BC️ Webpacker Build"
promotions:
  - name: Production
    pipeline_file: production.yml
    auto_promote:
      when: result = 'passed' and branch = 'master'
