version: v1.0
name: CI Pipeline
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Test suite #1'
    task:
      jobs:
        - name: running tests
          commands:
            - |
              if (( RANDOM % 2 == 0 )); then
                echo "Command succeeded";
              else
                echo "Command failed";
                return 1;
              fi
      secrets:
        - name: API_TOKEN
    dependencies:
      - 'Block #1'
  - name: 'Block #1'
    dependencies: []
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - echo "run"
after_pipeline:
  task:
    jobs:
      - name: Rebuild pipeline
        commands:
          - echo $SEMAPHORE_PIPELINE_ID
          - |
            if [ "$SEMAPHORE_PIPELINE_ID" = "failed" ]; then
              curl https://storage.googleapis.com/sem-cli-releases/get.sh | bash
              sem connect semaphore-demo-flow.semaphoreci.com $API_TOKEN
              sem rebuild pipeline $SEMAPHORE_PIPELINE_ID
            else
              echo "Pipeline result is not 'failed'. Skipping commands."
            fi
