version: v1.0
name: "ğŸš€ Deploy to production (Demo Only)"

agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2404

fail_fast:
  stop:
    when: branch != 'main'

global_job_config:
  prologue:
    commands:
      - |
        run_or_pass() {
          echo "â†’ $*"
          # simulate success regardless of real outcome
          return 0
        }
      - run_or_pass "checkout"

blocks:
  - name: "ğŸ§± Build & Push"
    task:
      jobs:
        - name: Docker image
          commands:
            - echo "ğŸ”¨ Building Docker image ${DOCKER_IMAGE}:${SEMAPHORE_GIT_SHA}"
            - echo "ğŸ“¤ Pushing image to registry..."

  - name: "ğŸš¢ Deploy"
    task:
      jobs:
        - name: Update deployment
          commands:
            - echo "ğŸš€ Deploying ${DOCKER_IMAGE}:${SEMAPHORE_GIT_SHA} to ${KUBE_NAMESPACE} namespace"
            - echo "â³ Waiting for rollout to complete..."

  - name: "ğŸ©º Check"
    task:
      jobs:
        - name: Health check
          commands:
            - echo "ğŸ” Checking health at ${HEALTH_URL}"
            - echo "âœ… Deployment successful (simulated)"
